@model QL_BANDIENTHOAI.Models.ViewModel.CheckoutViewModel
@{
    Layout = null;
    ViewBag.Title = "Thanh toán đơn hàng";
}
@Html.Partial("_HeaderCustom")

<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="utf-8" />
    <title>@ViewBag.Title</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" rel="stylesheet" />
    <style>
        body {
            background: #f5f7ff;
            font-family: Arial, sans-serif;
        }

        .checkout-container {
            max-width: 1100px;
            margin: 40px auto;
            background: #fff;
            padding: 35px;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.12);
        }

        .checkout-title {
            font-size: 30px;
            font-weight: 700;
            color: #c8242e;
            text-align: center;
            margin-bottom: 35px;
        }

        .info-card, .voucher-card, .payment-card, .summary-card {
            background: #fff;
            border-radius: 16px;
            padding: 25px;
            margin-bottom: 25px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
            border: 1px solid #eee;
        }

        .card-title {
            font-size: 20px;
            font-weight: 700;
            color: #c8242e;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #c8242e;
        }

        .form-control, .form-select {
            border-radius: 12px;
            padding: 12px 16px;
            font-size: 16px;
            border: 2px solid #ddd;
        }

            .form-control[readonly] {
                background: #f9f9f9;
                color: #333;
            }

        .product-item {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 18px 0;
            border-bottom: 1px dashed #eee;
        }

            .product-item img {
                width: 80px;
                height: 80px;
                object-fit: contain;
                background: #f9f9f9;
                border-radius: 12px;
                padding: 8px;
                border: 1px solid #eee;
            }

        .product-name {
            font-weight: 600;
            font-size: 17px;
        }

        .product-price {
            color: #c8242e;
            font-weight: bold;
            font-size: 18px;
        }

        .summary-row {
            display: flex;
            justify-content: space-between;
            padding: 12px 0;
            font-size: 18px;
        }

        .final-total {
            font-size: 28px;
            font-weight: 800;
            color: #c8242e;
        }

        .btn-order {
            background: #c8242e;
            border: none;
            padding: 18px;
            color: #fff;
            font-weight: 700;
            font-size: 20px;
            border-radius: 16px;
            width: 100%;
            margin-top: 20px;
            box-shadow: 0 8px 20px rgba(200,36,46,0.4);
            transition: all 0.3s;
        }

            .btn-order:hover {
                background: #a01822;
                transform: translateY(-3px);
            }

        .toast-success {
            position: fixed;
            bottom: 30px;
            right: 30px;
            background: linear-gradient(135deg, #28a745, #20c997);
            color: white;
            padding: 20px 40px;
            border-radius: 16px;
            font-size: 19px;
            font-weight: bold;
            z-index: 99999;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            display: flex;
            align-items: center;
            gap: 12px;
        }
    </style>
</head>
<body>

    <div class="checkout-container">
        <h2 class="checkout-title">
            XÁC NHẬN ĐƠN HÀNG
        </h2>

        <div class="row g-4">
            <!-- CỘT TRÁI -->
            <div class="col-lg-8">

                <!-- Thông tin nhận hàng -->
                <div class="info-card">
                    <div class="card-title">
                        Thông tin giao hàng
                    </div>
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label class="form-label fw-bold">Họ tên</label>
                            <input type="text" class="form-control" value="@Model.HoTen" readonly />
                        </div>
                        <div class="col-md-6">
                            <label class="form-label fw-bold">Số điện thoại</label>
                            <input type="text" class="form-control" value="@Model.SDT" readonly />
                        </div>
                        <div class="col-12">
                            <label class="form-label fw-bold">Địa chỉ</label>
                            <textarea class="form-control" rows="3" readonly>@Model.DiaChi</textarea>
                        </div>
                    </div>
                </div>

                <!-- Chọn Voucher -->
                <div class="voucher-card">
                    <div class="card-title">
                        Chọn mã giảm giá (@Model.Vouchers.Count có sẵn)
                    </div>
                    <select id="voucherSelect" class="form-select form-select-lg">
                        <option value="0" data-loai="" data-mapkm="">Không sử dụng voucher</option>
                        @foreach (var v in Model.Vouchers)
                        {
                            <option value="@v.GiaTri" data-loai="@v.LoaiPhieu" data-mapkm="@v.MaPKM">
                                [@v.MaPKM] @(v.LoaiPhieu == "GIAMGIA" ? "Giảm " + v.GiaTri + "%" : "Giảm " + String.Format("{0:N0}", v.GiaTri) + "đ")
                                – Hết hạn: @v.NgayHetHan.ToString("dd/MM/yyyy")
                            </option>
                        }
                    </select>
                </div>

                <!-- Phương thức thanh toán -->
                <div class="payment-card">
                    <div class="card-title">
                        Phương thức thanh toán
                    </div>
                    <div class="form-check mb-3">
                        <input class="form-check-input" type="radio" name="pttt" id="cod" value="COD" checked style="transform:scale(1.6);">
                        <label class="form-check-label fw-bold text-danger fs-4 ms-3" for="cod">
                            Thanh toán khi nhận hàng (COD)
                        </label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="pttt" id="bank" value="BANK" style="transform:scale(1.6);">
                        <label class="form-check-label fs-5 ms-3" for="bank">Chuyển khoản ngân hàng</label>
                    </div>
                </div>
            </div>

            <!-- CỘT PHẢI - Tóm tắt -->
            <div class="col-lg-4">
                <div class="summary-card">
                    <div class="card-title text-center">
                        Tóm tắt đơn hàng
                    </div>

                    @foreach (var item in Model.CartItems)
                    {
                        <div class="product-item">
                            <img src="@Url.Content("~/Content/" + item.AnhSanPham)" alt="@item.TenSp" />
                            <div style="flex:1">
                                <div class="product-name">@item.TenSp</div>
                                <small class="text-muted">x @item.SoLuong</small>
                            </div>
                            <div class="product-price">
                                @String.Format("{0:N0}đ", item.GiaBan * item.SoLuong)
                            </div>
                        </div>
                    }

                    <hr class="my-4" style="border-top:2px dashed #ddd;" />

                    <div class="summary-row">
                        <span>Tạm tính (@Model.SoLuongSP sản phẩm):</span>
                        <strong>@String.Format("{0:N0}", Model.TongTien) đ</strong>
                    </div>
                    <div class="summary-row text-success fw-bold">
                        <span>Giảm giá voucher:</span>
                        <strong id="giamGia">0 đ</strong>
                    </div>
                    <div class="summary-row border-top pt-3 mt-3">
                        <span class="final-total">Thành tiền:</span>
                        <span class="final-total" id="tongCong">@String.Format("{0:N0}", Model.TongTien) đ</span>
                    </div>

                    <button onclick="datHang()" class="btn-order">
                        HOÀN TẤT ĐẶT HÀNG
                    </button>
                </div>
            </div>
        </div>
    </div>

    @Html.Partial("_FooterCustom")

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
    var tongTienGoc = @Model.TongTien;

    $("#voucherSelect").change(function () {
        var giaTri = parseFloat($(this).val()) || 0;
        var loai = $(this).find("option:selected").data("loai");
        var giam = 0;

        if (loai === "GIAMGIA") giam = tongTienGoc * (giaTri / 100);
        else if (loai === "GIAMTIEN") giam = giaTri;

        $("#giamGia").text("-" + giam.toLocaleString() + " đ");
        $("#tongCong").text((tongTienGoc - giam).toLocaleString() + " đ");
    });

    function datHang() {
        var pttt = $("input[name='pttt']:checked").val();
        var maPKM = $("#voucherSelect option:selected").data("mapkm") || "";

        $.post("/Checkout/DatHang", { phuongThuc: pttt, maPKM: maPKM }, function (res) {
            if (res.success) {
                var toast = $('<div class="toast-success">Đặt hàng thành công! Đang chuyển hướng...</div>');
                $("body").append(toast);
                toast.hide().fadeIn(400);
                setTimeout(() => {
                    toast.fadeOut(600, () => toast.remove());
                    window.location.href = "/DonHang";
                }, 2500);
            } else {
                alert("Lỗi: " + (res.message || "Không thể đặt hàng"));
            }
        }).fail(() => alert("Lỗi kết nối server!"));
    }
    </script>

</body>
</html>